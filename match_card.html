<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataGaffer Match Cards</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f2f4f7;
    color: #003f2e;
    margin: 0;
    padding: 0;
  }

  /* ✅ Header bar styling */
  .header-bar {
    background-color: #003f2e;
    color: white;
    padding: 10px 20px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .header-logo {
    height: 80px;
    width: auto;
    position: absolute;
    left: 20px;
    top: 0;
  }
  .header-bar h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
  }

  /* ✅ Search box styling */
  .search-box {
    text-align: center;
    margin: 15px 0 20px 0;
  }
  .search-box input {
    width: 260px;
    padding: 8px;
    font-size: 14px;
    border: 2px solid #003f2e;
    border-radius: 6px;
  }

  /* ✅ Main layout */
  .container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(440px, 1fr));
    gap: 22px;
    padding: 16px;
  }

  .card {
    background: #fff;
    border: 2px solid #003f2e;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    padding: 14px 18px;
    transition: transform .25s;
  }
  .card:hover { transform: scale(1.01); }

  .header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 4px;
  }
  .header img { height: 42px; width: auto; }
  .header h3 { font-size: 16px; font-weight: 700; margin: 0; }

  .section {
    border-top: 1px solid #e1e5e2;
    margin-top: 2px;
    padding-top: 2px;
  }
  .section h4 {
    text-align: center;
    font-size: 15px;
    font-weight: 700;
    margin: 4px 0;
  }

  .form-line {
    text-align: center;
    font-weight: 700;
    letter-spacing: 2px;
    margin-bottom: 6px;
    margin-top: 4px;
  }
  .form-line span {
    padding: 2px 4px;
    border-radius: 3px;
    margin: 0 1px;
    color: white;
  }
  .win { background: #2e8b57; }
  .draw { background: #a9a9a9; }
  .loss { background: #c62828; }

  .form-grid, .stat-grid {
    display: grid;
    grid-template-columns: repeat(2,1fr);
    gap: 6px;
    font-size: 13px;
    text-align: center;
  }

  .h2h-bar {
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .value-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 6px;
  }
  .value-table th, .value-table td {
    border: 1px solid #ddd;
    padding: 4px 6px;
    text-align: center;
  }
  .value-table th { background: #f2f9f3; font-weight: 700; }

  .gradient-cell { font-weight: bold; border-radius: 4px; padding: 2px 4px; }

  .projected-grid {
    display: flex;
    justify-content: space-around;
    text-align: center;
    gap: 6px;
  }
  .projected-grid .label {
    font-weight: 600;
    color: #003f2e;
    margin-bottom: 2px;
    font-size: 11px;
    border-bottom: 1px solid #d8e0db;
  }
  .highlight {
    background: #d4f7d9;
    border-radius: 4px;
    padding: 1px 4px;
  }
  .projected-grid div div:last-child { font-size: 12px; }

  @media (max-width: 768px) {
    .header-logo { height: 50px; }
    .header-bar h1 { font-size: 20px; }
    .container { grid-template-columns: 1fr; }
    .header h3 { font-size: 14px; }
  }
</style>
</head>
<body>

<!-- ✅ Header bar -->
<div class="header-bar">
  <a href="dashboard.html" style="text-decoration:none; color:inherit; display:contents;">
    <img src="https://cdn.prod.website-files.com/682236b4aa8cdb4803142afd/68b8aa71d38f0c8d4c140700_everything-236.png" alt="DG Logo" class="header-logo" />
    <h1>DataGaffer.com</h1>
  </a>
</div>

<!-- ✅ Search bar -->
<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search team, matchup, or league..." onkeyup="applySearch()">
</div>

<div class="container" id="cards"></div>

<script>
let allFixtures = [];

async function loadFixtures() {
  const [formData, fixturesData] = await Promise.all([
    fetch("h2h_form_combined.json").then(r => r.json()),
    fetch("fixtures.json").then(r => r.json())
  ]);

  const formList = Array.isArray(formData.matches) ? formData.matches : formData;
  const fixtureList = Array.isArray(fixturesData) ? fixturesData : fixturesData.fixtures || fixturesData;

  allFixtures = formList.map(formMatch => {
    const fx = fixtureList.find(f =>
      f.home?.name === formMatch.home_name && f.away?.name === formMatch.away_name
    );
    return { ...formMatch, ...fx };
  });

  renderCards(allFixtures);
}

function applySearch() {
  const term = document.getElementById("searchInput").value.toLowerCase();
  const filtered = allFixtures.filter(f =>
    f.home_name.toLowerCase().includes(term) ||
    f.away_name.toLowerCase().includes(term) ||
    (f.league?.name?.toLowerCase() || "").includes(term)
  );
  renderCards(filtered);
}

function renderCards(fixtures) {
  const container = document.getElementById("cards");
  container.innerHTML = "";
  const thief = new ColorThief();

  fixtures.forEach(match => {
    const sim = match.sim_stats || {};
    const perc = sim.percents || {};
    const book = match.book_odds || {};
    const h2h = match.h2h || {};

    const colorForm = form => form.split("").map(c => {
      if (c === "W") return `<span class="win">${c}</span>`;
      if (c === "L") return `<span class="loss">${c}</span>`;
      if (c === "D") return `<span class="draw">${c}</span>`;
      return c;
    }).join("");

    const highlight = (a, b) => parseFloat(a) > parseFloat(b)
      ? ["highlight", ""] : parseFloat(b) > parseFloat(a)
      ? ["", "highlight"] : ["", ""];

    const gHL = highlight(sim.xg?.home, sim.xg?.away);
    const cHL = highlight(sim.corners?.home, sim.corners?.away);
    const sHL = highlight(sim.shots?.home, sim.shots?.away);

    const calcValue = (simPct, bookOdds) => {
      if (!simPct || !bookOdds) return "<td>–</td>";
      const simProb = simPct / 100;
      const bookProb = 1 / bookOdds;
      const val = (simProb - bookProb) * 100;
      const bg = val > 0 ? `background:rgba(0,180,0,${Math.min(0.3, val / 100)});` :
                 val < 0 ? `background:rgba(255,0,0,${Math.min(0.3, Math.abs(val) / 100)});` : "";
      return `<td class="gradient-cell" style="${bg}">${val > 0 ? "+" : ""}${val.toFixed(1)}%</td>`;
    };

    const tableRows = [
      ["Home Win", perc.home_win_pct, book.home_win],
      ["Draw", perc.draw_pct, book.draw],
      ["Away Win", perc.away_win_pct, book.away_win],
      ["Over 2.5", perc.over_2_5_pct, book.over_2_5],
      ["BTTS", perc.btts_pct, book.btts],
      ["Home O1.5", perc.home_o1_5_pct, book.home_o1_5],
      ["Away O1.5", perc.away_o1_5_pct, book.away_o1_5]
    ].map(([label, simPct, bookOdds]) => {
      const simOdds = simPct ? (100 / simPct).toFixed(2) : "–";
      const bookStr = bookOdds ?? "–";
      return `<tr><td>${label}</td><td>${simPct ?? "–"}%</td><td>${simOdds}</td><td>${bookStr}</td>${calcValue(simPct, bookOdds)}</tr>`;
    }).join("");

    const slug = `${match.home_name.toLowerCase().replace(/[^a-z0-9]+/g, '')}-vs-${match.away_name.toLowerCase().replace(/[^a-z0-9]+/g, '')}`;
    const card = `
        <div class="card" id="${slug}">
        <div class="header">
          <img src="${match.home_logo}" class="home-logo">
          <h3><span class="home-name">${match.home_name}</span> vs <span class="away-name">${match.away_name}</span></h3>
          <img src="${match.away_logo}" class="away-logo">
        </div>

        <div class="section">
          <h4>Form (Last 5)</h4>
          <div class="form-line">${colorForm(match.home_form_last5 || "-----")} &nbsp;|&nbsp; ${colorForm(match.away_form_last5 || "-----")}</div>
          <div class="form-grid">
  <div>Win %: ${match.home_form_win || 0}%</div><div>Win %: ${match.away_form_win || 0}%</div>
  <div>Over 1.5: ${match.home_form_o15 || 0}%</div><div>Over 1.5: ${match.away_form_o15 || 0}%</div>
  <div>Over 2.5: ${match.home_form_o25 || 0}%</div><div>Over 2.5: ${match.away_form_o25 || 0}%</div>
  <div>Over 3.5: ${match.home_form_o35 || 0}%</div><div>Over 3.5: ${match.away_form_o35 || 0}%</div>
  <div>BTTS: ${match.home_form_btts || 0}%</div><div>BTTS: ${match.away_form_btts || 0}%</div>
</div>
        </div>

        <div class="section">
          <h4>Head-to-Head (Last 10)</h4>
          <div class="h2h-bar">${match.home_name} ${h2h.home_wins || 0}W | Draws ${h2h.draws || 0} | ${match.away_name} ${h2h.away_wins || 0}W</div>
          <div class="stat-grid">
  <div>Over 1.5: ${h2h.over_1_5_pct || 0}%</div><div>Over 2.5: ${h2h.over_2_5_pct || 0}%</div>
  <div>Over 3.5: ${h2h.over_3_5_pct || 0}%</div><div>BTTS: ${h2h.btts_pct || 0}%</div>
  <div style="grid-column: span 2; text-align:center; font-weight:600;">
  Avg Goals: ${(h2h.avg_home_goals || 0).toFixed(2)} | ${(h2h.avg_away_goals || 0).toFixed(2)}
</div>
</div>
        </div>

        <div class="section">
          <h4>Simulated vs Book Odds</h4>
          <table class="value-table">
            <tr><th>Market</th><th>Sim %</th><th>Sim Odds</th><th>Book</th><th>Value</th></tr>
            ${tableRows}
          </table>
        </div>

        <div class="section">
          <h4>Projected Stats</h4>
          <div class="projected-grid">
            <div>
              <div class="label">Goals</div>
              <div><span class="${highlight(sim.xg?.home, sim.xg?.away)[0]}">${sim.xg?.home ?? "–"}</span> - <span class="${highlight(sim.xg?.home, sim.xg?.away)[1]}">${sim.xg?.away ?? "–"}</span></div>
            </div>
            <div>
              <div class="label">Corners</div>
              <div><span class="${highlight(sim.corners?.home, sim.corners?.away)[0]}">${sim.corners?.home ?? "–"}</span> - <span class="${highlight(sim.corners?.home, sim.corners?.away)[1]}">${sim.corners?.away ?? "–"}</span></div>
            </div>
            <div>
              <div class="label">Shots</div>
              <div><span class="${highlight(sim.shots?.home, sim.shots?.away)[0]}">${sim.shots?.home ?? "–"}</span> - <span class="${highlight(sim.shots?.home, sim.shots?.away)[1]}">${sim.shots?.away ?? "–"}</span></div>
            </div>
          </div>
        </div>
      </div>
    `;
    container.innerHTML += card;
  });

  // ✅ Team name colorization
  setTimeout(() => {
    document.querySelectorAll(".card").forEach(card => {
      const homeImg = card.querySelector(".home-logo");
      const awayImg = card.querySelector(".away-logo");
      const homeName = card.querySelector(".home-name");
      const awayName = card.querySelector(".away-name");
      homeImg.crossOrigin = "Anonymous";
      awayImg.crossOrigin = "Anonymous";
      const thief = new ColorThief();
      const apply = (img, el) => {
        try {
          const [r, g, b] = thief.getColor(img);
          el.style.color = `rgb(${r * 0.7},${g * 0.7},${b * 0.7})`;
        } catch {}
      };
      if (homeImg.complete) apply(homeImg, homeName);
      else homeImg.addEventListener("load", () => apply(homeImg, homeName), { once: true });
      if (awayImg.complete) apply(awayImg, awayName);
      else awayImg.addEventListener("load", () => apply(awayImg, awayName), { once: true });
    });
  }, 500);
}

// --- Scroll to correct card if arriving from dashboard ---
window.addEventListener("DOMContentLoaded", () => {
  const hash = decodeURIComponent(window.location.hash.slice(1));
  if (!hash) return;

  const checkCard = setInterval(() => {
    const target = document.getElementById(hash);
    if (target) {
      clearInterval(checkCard);
      target.scrollIntoView({ behavior: "smooth", block: "center" });
      target.style.boxShadow = "0 0 15px 3px rgba(0,128,0,0.4)";
      target.style.transform = "scale(1.02)";
      setTimeout(() => {
        target.style.boxShadow = "";
        target.style.transform = "";
      }, 2000);
    }
  }, 300);
});



// ✅ Ensure it runs after fixtures load
loadFixtures();

</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* --- Supabase setup --- */
const SUPABASE_URL = "https://qgniftwopmhhcwiatkku.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnbmlmdHdvcG1oaGN3aWF0a2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjc2MzMsImV4cCI6MjA3MzgwMzYzM30.TYHTz4d9bT7OjdEkmu0m5lu-St75BWHOJQd8FLcKm5E";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, detectSessionInUrl: true }
});

/* --- Prevent Safari/Chrome back-button cache bypass --- */
window.addEventListener("pageshow", function (event) {
  if (event.persisted) {
    console.log("Reloading to bypass Safari back cache");
    window.location.reload();
  }
});

/* --- Inactivity logout (15 minutes) --- */
const INACTIVITY_LIMIT = 15 * 60 * 1000;
let inactivityTimer;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(async () => {
    console.log("Auto-logout after inactivity");
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }, INACTIVITY_LIMIT);
}
["click", "mousemove", "keydown", "scroll", "touchstart"].forEach(evt =>
  document.addEventListener(evt, resetInactivityTimer)
);
resetInactivityTimer();

/* --- Explicit logout handling --- */
supabaseClient.auth.onAuthStateChange((event) => {
  if (event === "SIGNED_OUT") {
    console.log("User signed out → redirecting to login");
    window.location.href = "login.html";
  }
});

/* --- Subscription enforcement --- */
document.body.style.display = "none"; // hide content until validated

(async () => {
  const { data: { session }, error } = await supabaseClient.auth.getSession();
  if (error || !session) {
    console.warn("No session → redirecting to login");
    window.location.href = "login.html";
    return;
  }

  // --- Try matching by Supabase Auth ID first ---
  let { data: profile, error: profileError } = await supabaseClient
    .from("profiles")
    .select("is_subscribed, plan")
    .eq("id", session.user.id)
    .maybeSingle();

  // --- Fallback: try matching by email if profile not found or Stripe-created first ---
  if ((!profile || profileError) && session.user.email) {
    const { data: byEmail } = await supabaseClient
      .from("profiles")
      .select("is_subscribed, plan")
      .eq("email", session.user.email.toLowerCase())
      .maybeSingle();
    profile = byEmail;
  }

  // --- Subscription validation ---
  if (!profile?.is_subscribed) {
    console.warn("Not subscribed → redirecting to subscribe page");
    window.location.href = "subscribe.html";
    return;
  }

  // ✅ Allow only active monthly/yearly users
  if (profile.plan === "monthly" || profile.plan === "yearly") {
    console.log("✅ Active plan:", profile.plan, "→ Showing page");
    document.body.style.display = "block";
  } else {
    console.warn("User has unsupported plan:", profile.plan);
    window.location.href = "subscribe.html";
  }
})();
</script>

</body>
</html>






