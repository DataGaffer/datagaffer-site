<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Match Cards</title>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <meta name="theme-color" content="#ffffff">

  <!-- Color Thief (used to extract dominant logo color) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f2f4f7; color:#003f2e; }

    /* Header */
    .header-bar {
      background-color: #003f2e;
      color: white;
      padding: 10px 20px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header-logo {
      height: 90px;
      width: auto;
      position: absolute;
      left: 20px;
      top: 0;
    }
    .header-bar h1 {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
    }

    .banner {
      text-align: center;
      font-size: 20px;
      margin: 20px auto 40px auto;
      color: #003f2e;
      background: #ffffff;
      padding: 10px;
      border: 2px solid #003f2e;
      width: 60%;
      border-radius: 4px;
      font-weight: 600;
      line-height: 1.5;
    }

    .search-box { text-align: center; margin-bottom: 20px; }
    .search-box input {
      width: 250px;
      padding: 8px;
      font-size: 14px;
      border: 2px solid #003f2e;
      border-radius: 6px;
    }

    /* Cards */
    .container { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:16px; padding:16px; }
    .card {
      background:#ffffff;
      border-radius:10px;
      padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
      border: 2px solid #003f2e;
      scroll-margin-top: 80px;
      transition: box-shadow 0.4s ease, transform 0.3s ease;
    }

    .card.highlight {
      box-shadow: 0 0 16px 4px #015326;
      transform: scale(1.02);
    }

    .card h3 {
      margin:0 0 10px;
      font-size: 18px;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .card .team-name {
      font-weight:700;
      transition: color .2s ease;
    }

    .club-logo { height:22px; width:auto; vertical-align:middle; }

    .section { background:#f6f9f7; border:1px solid #dfe9e3; border-radius:8px; padding:10px; margin-bottom:10px; }
    .section h4 { margin:0 0 8px; font-size:15px; text-align:center; }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      text-align:center;
    }
    th, td { padding:4px; }
    th {
      font-weight:600;
      border-bottom:1px solid #d8e0db;
      color:#003f2e;
      font-size:13px;
    }

    .gradient-cell {
      font-weight: bold;
      border-radius:4px;
      padding:3px 4px;
    }

    .projected-grid {
      display: flex;
      justify-content: space-around;
      text-align: center;
      gap: 8px;
    }
    .projected-grid .label {
      font-weight: 700;
      color: #003f2e;
      margin-bottom: 4px;
      font-size: 14px;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .header-logo { height: 50px !important; }
      .header-bar h1 { font-size: 20px !important; }
      .banner { width: 85% !important; font-size: 13px !important; }
      .container { grid-template-columns: 1fr !important; }
      .card { padding:10px !important; }
      th, td { font-size:11px !important; }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header-bar">
  <a href="dashboard.html" style="text-decoration:none; color:inherit; display:contents;">
    <img src="https://cdn.prod.website-files.com/682236b4aa8cdb4803142afd/68b8aa71d38f0c8d4c140700_everything-236.png"
         alt="DG Logo" class="header-logo" />
    <h1>DataGaffer.com</h1>
  </a>
</div>

<div class="banner">Full match cards showing projected stats and DataGaffer vs bookmaker values.</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search team, matchup, or league..." onkeyup="applySearch()" />
</div>

<div class="container" id="cards"></div>

<script>
function toDecimalOdds(prob) {
  if (!prob || prob <= 0 || prob >= 100) return null;
  return +(100 / prob).toFixed(2);
}

function colorFromRatio(r, start, end) {
  r = Math.max(0, Math.min(1, r));
  const rr = Math.round(start.r + (end.r - start.r) * r);
  const gg = Math.round(start.g + (end.g - start.g) * r);
  const bb = Math.round(start.b + (end.b - start.b) * r);
  return `rgb(${rr},${gg},${bb})`;
}

function getValueGradient(value, min, max) {
  if (!isFinite(value)) return "white";
  if (value >= 0) {
    const ratio = value / Math.max(1e-6, max);
    return colorFromRatio(ratio * 0.85, { r:255,g:255,b:255 }, { r:90,g:210,b:120 });
  } else {
    const ratio = Math.abs(value) / Math.max(1e-6, Math.abs(min));
    return colorFromRatio(ratio * 0.85, { r:255,g:255,b:255 }, { r:240,g:90,b:90 });
  }
}

async function loadFixtures() {
  return await fetch("fixtures.json").then(r => r.json());
}

function buildCard(f) {
  const slug = `${f.home.name.toLowerCase().replace(/[^a-z0-9]/g, '')}-vs-${f.away.name.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
  const sim = f.sim_stats || {};
  const perc = sim.percents || {};
  const book = f.book_odds || {};

  const projected = `
  <div class="section">
    <h4>Projected Stats</h4>
    <div class="projected-grid">
      <div><div class="label">Goals</div><div>${sim.xg?.home ?? "–"} - ${sim.xg?.away ?? "–"}</div></div>
      <div><div class="label">Corners</div><div>${sim.corners?.home ?? "–"} - ${sim.corners?.away ?? "–"}</div></div>
      <div><div class="label">Shots</div><div>${sim.shots?.home ?? "–"} - ${sim.shots?.away ?? "–"}</div></div>
    </div>
  </div>`;

  const markets = [
    ["Home Win", perc.home_win_pct, book.home_win],
    ["Draw", perc.draw_pct, book.draw],
    ["Away Win", perc.away_win_pct, book.away_win],
    ["Home o1.5", perc.home_o1_5_pct, book.home_o1_5],
    ["Away o1.5", perc.away_o1_5_pct, book.away_o1_5],
    ["Over 2.5", perc.over_2_5_pct, book.over_2_5],
    ["BTTS", perc.btts_pct, book.btts]
  ];

  const diffs = markets.map(([_, simPct, bookOdds]) => {
    if (!simPct || !bookOdds) return null;
    const simProb = simPct / 100;
    const bookProb = 1 / bookOdds;
    return (simProb - bookProb) * 100;
  });

  const minDiff = Math.min(...diffs.filter(v => v !== null));
  const maxDiff = Math.max(...diffs.filter(v => v !== null));

  const tableRows = markets.map(([label, simPct, bookOdds], i) => {
    const simOdds = toDecimalOdds(simPct);
    const val = diffs[i];
    const bg = val !== null ? getValueGradient(val, minDiff, maxDiff) : "white";
    return `
      <tr>
        <td>${label}</td>
        <td>${simPct ? simPct + "%" : "–"}</td>
        <td>${simOdds ?? "–"}</td>
        <td>${bookOdds ?? "–"}</td>
        <td class="gradient-cell" style="background:${bg}">
          ${val !== null ? (val >= 0 ? "+" + val.toFixed(1) + "%" : val.toFixed(1) + "%") : "–"}
        </td>
      </tr>`;
  }).join("");

  const table = `
    <div class="section">
      <h4>Sim vs Book Odds</h4>
      <table>
        <tr><th>Market</th><th>Sim %</th><th>Sim Odds</th><th>Book</th><th>Value</th></tr>
        ${tableRows}
      </table>
    </div>`;

  return `
    <div class="card" id="${slug}">
      <h3>
        <img class="club-logo home-logo" src="${f.home.logo}" alt="${f.home.name}" crossorigin="anonymous">
        <span class="team-name home-name">${f.home.name}</span>
        &nbsp;vs&nbsp;
        <span class="team-name away-name">${f.away.name}</span>
        <img class="club-logo away-logo" src="${f.away.logo}" alt="${f.away.name}" crossorigin="anonymous">
      </h3>
      ${projected}
      ${table}
    </div>`;
}

function colorizeTeamNames() {
  if (typeof ColorThief === "undefined") return;
  const thief = new ColorThief();
  document.querySelectorAll(".card").forEach(card => {
    const homeImg  = card.querySelector(".home-logo");
    const awayImg  = card.querySelector(".away-logo");
    const homeName = card.querySelector(".home-name");
    const awayName = card.querySelector(".away-name");
    const applyColor = (img, nameEl) => {
      if (!img || !nameEl) return;
      try {
        const [r,g,b] = thief.getColor(img);
        const dr = Math.max(0, Math.floor(r * 0.75));
        const dg = Math.max(0, Math.floor(g * 0.75));
        const db = Math.max(0, Math.floor(b * 0.75));
        nameEl.style.color = `rgb(${dr},${dg},${db})`;
      } catch { nameEl.style.color = "#0b3d2e"; }
    };
    if (homeImg.complete && homeImg.naturalWidth) applyColor(homeImg, homeName);
    else homeImg.addEventListener("load", () => applyColor(homeImg, homeName), { once:true });
    if (awayImg.complete && awayImg.naturalWidth) applyColor(awayImg, awayName);
    else awayImg.addEventListener("load", () => applyColor(awayImg, awayName), { once:true });
  });
}

let allFixtures = [];
async function init() {
  allFixtures = await loadFixtures();
  applySearch();
  setTimeout(colorizeTeamNames, 150);

  // scroll to match if hash provided
  const hash = window.location.hash.substring(1);
  if (hash) {
    const target = document.getElementById(hash);
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
        target.classList.add("highlight");
        setTimeout(() => target.classList.remove("highlight"), 1000);
      }, 600);
    }
  }
}

function applySearch() {
  const term = document.getElementById("searchInput").value.toLowerCase();
  const filtered = allFixtures.filter(f =>
    f.home.name.toLowerCase().includes(term) ||
    f.away.name.toLowerCase().includes(term) ||
    (f.league && f.league.name.toLowerCase().includes(term))
  );
  document.getElementById("cards").innerHTML = filtered.map(buildCard).join("");
  setTimeout(colorizeTeamNames, 50);
}

init();
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://qgniftwopmhhcwiatkku.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnbmlmdHdvcG1oaGN3aWF0a2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjc2MzMsImV4cCI6MjA3MzgwMzYzM30.TYHTz4d9bT7OjdEkmu0m5lu-St75BWHOJQd8FLcKm5E";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
document.body.style.display = "none";

(async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) return window.location.href = "login.html";

  const { data: profile } = await supabaseClient
    .from("profiles")
    .select("is_subscribed, plan")
    .eq("id", session.user.id)
    .maybeSingle();

  if (!profile?.is_subscribed || !["monthly","yearly"].includes(profile.plan)) {
    window.location.href = "subscribe.html";
    return;
  }

  document.body.style.display = "block";
})();
</script>
</body>
</html>





