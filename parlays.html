<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Parlay Builder</title>
<!-- ✅ Favicons for all browsers and devices -->
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
<meta name="theme-color" content="#ffffff">
<style>
  body{font-family:Arial, sans-serif;margin:0;background:#f2f4f7}
  .header{background:#003f2e;color:#fff;display:flex;align-items:center;justify-content:center;position:relative;padding:10px 20px}
  .header img{height:90px;position:absolute;left:20px;top:0}
  .header h1{margin:0;font-size:32px;font-weight:700}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .banner{background:#fff;border:2px solid #003f2e;border-radius:6px;padding:10px 14px;text-align:center;font-weight:600;color:#003f2e}
  .buttons{text-align:center;margin:20px 0}
  .btn{padding:10px 18px;margin:0 6px;font-weight:bold;background:#003f2e;color:#fff;border:none;border-radius:6px;cursor:pointer}
  .btn:hover{background:#046e47}
  .cards{display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:10px}
  .card{background:#fff;border-radius:12px;border:2px solid #003f2e;box-shadow:0 3px 12px rgba(0,0,0,.12);padding:16px;width:90%;max-width:700px}
  .card h2{margin:0 0 10px 0;text-align:center;color:#003f2e}
  .legs{border-top:1px solid #e8efe9;margin-top:10px;padding-top:10px}
  .leg{display:flex;justify-content:space-between;gap:10px;background:#eef5f7;border:1px solid #dfe9e3;border-radius:8px;padding:12px;margin:8px 0}
  .leg .left{max-width:62%}
  .leg .title{font-weight:700}
  .pill{display:inline-block;padding:2px 2px;border-radius:999px;background:#0ea768;color:#fff;font-weight:700;font-size:12px}
  .row{display:flex;justify-content:space-between;margin-top:6px;font-size:13px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .kpi>div{background:#fffdf7;border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
  .kpi .big{font-weight:800;font-size:18px;color:#0b8c53}
  .tiny{color:#666;font-size:13px}
  .muted{color:#4e5a55}
  .footer-note{margin-top:10px;color:#51615a;font-size:12px;text-align:center}
  .btn.active {background: #046e47;border: 2px solid #003f2e;}

  .betway-banner {
  margin-top: 15px;
  text-align: center;
  background: #003f2e;
  border-radius: 8px;
  padding: 8px 10px;
  transition: background 0.25s ease;
}

.betway-banner a {
  display: flex;
  flex-direction: row-reverse;   /* logo on right side */
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: white;
  text-decoration: none;
  font-weight: 600;
  font-size: 22px;
  height: 30px;                  /* clean vertical balance */
  line-height: 1;
}

.betway-banner img {
  height: 22px;
  filter: brightness(0) invert(1);
}

.betway-banner:hover {
  background: #046e47;
}
@keyframes slideUpFade {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.betway-banner {
  animation: slideUpFade 0.6s ease forwards;  /* ✨ subtle slide & fade-in */
}

@media (max-width:900px){
  .betway-banner a { font-size: 16px; height: 24px; }
  .betway-banner img { height: 16px; }

    .header img{height:50px}
    .header h1{font-size:20px}
    .card{width:95%}
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <a href="index.html" style="text-decoration:none;color:inherit;display:contents;">
    <img src="https://cdn.prod.website-files.com/682236b4aa8cdb4803142afd/68b8aa71d38f0c8d4c140700_everything-236.png" alt="DG Logo">
    <h1>DataGaffer.com</h1>
  </a>
</div>

<div class="wrap">
  <div class="banner">AI generated EV parlays based on our DataGaffer simulations vs Betway odds</div>

  <!-- Buttons -->
  <div class="buttons">
    <button class="btn" onclick="showParlays(2)">2-Leg</button>
    <button class="btn" onclick="showParlays(3)">3-Leg</button>
    <button class="btn" onclick="showParlays(4)">4-Leg</button>
  </div>

  <div class="cards" id="parlay-cards"></div>

  <div class="footer-note">
    Edge = Sim Probability − Implied Probability from Betway odds. Parlays avoid combining two legs from the same match.
  </div>
</div>

<script>
const toDecimalOdds = pct => (pct>0 && pct<100) ? +(100/pct).toFixed(2) : null;
const impliedPct = dec => dec>1 ? +(100/dec).toFixed(1) : null;

const MARKET_MAP = [
  {sim:'home_win_pct', book:'home_win', label:(m)=>`${m.home.name} Win`, minSim:60, type:'win'},
  {sim:'away_win_pct', book:'away_win', label:(m)=>`${m.away.name} Win`, minSim:60, type:'win'},
  {sim:'over_2_5_pct', book:'over_2_5', label:()=>`Over 2.5`, minSim:50, type:'total'},
  {sim:'btts_pct', book:'btts', label:()=>`BTTS Yes`, minSim:50, type:'btts'},
  {sim:'home_o1_5_pct', book:'home_o1_5', label:(m)=>`${m.home.name} o1.5`, minSim:50, type:'team_total'},
  {sim:'away_o1_5_pct', book:'away_o1_5', label:(m)=>`${m.away.name} o1.5`, minSim:50, type:'team_total'}
];

function collectLegs(fixtures){
  const legs=[];
  for(const match of fixtures){
    const sim=match.sim_stats?.percents||{};
    const book=match.book_odds||{};
    for(const mk of MARKET_MAP){
      const p=sim[mk.sim], o=book[mk.book];
      if (typeof p==='number' && typeof o==='number' && p >= (mk.minSim || 55) && o>1){
        const imp=impliedPct(o);
        const edge=+(p-imp).toFixed(1);
        legs.push({
          matchId:match.fixture_id||`${match.home_id}-${match.away_id}`,
          desc:mk.label(match),
          simPct:+p.toFixed(1),
          bookOdds:+o.toFixed(2),
          edge,
          league:match.league?.name||'',
          teams:`${match.home.name} vs ${match.away.name}`,
          type:mk.type   // ✅ now legs know what kind they are
        });
      }
    }
  }
  return legs.sort((a,b)=>b.simPct - a.simPct || b.edge - a.edge);
}

// ✅ Only best leg per match
function buildPool(legs, poolSize = 200) {
  const byMatch = {};

  // group by match
  for (const leg of legs) {
    if (!byMatch[leg.matchId]) byMatch[leg.matchId] = [];
    byMatch[leg.matchId].push(leg);
  }

  // pick best per match (highest simPct, fallback edge)
  const pool = Object.values(byMatch).map(matchLegs => {
    return matchLegs.sort((a,b) => b.simPct - a.simPct || b.edge - a.edge)[0];
  });

  // sort pool by edge (strongest first)
  pool.sort((a,b) => b.edge - a.edge);

  return pool.slice(0, poolSize);
}

function combine(legs){
  const simProb=legs.reduce((a,l)=>a*(l.simPct/100),1);
  const bookDec=legs.reduce((a,l)=>a*l.bookOdds,1);
  const parlaySimPct=+(simProb*100).toFixed(1);
  const parlayImplied=impliedPct(bookDec);
  const edge=+(parlaySimPct-parlayImplied).toFixed(1);
  return {size:legs.length,legs,parlayDec:+bookDec.toFixed(2),parlaySimPct,parlayImplied,edge};
}

function bestParlays(legs, size, limit = 3) {
  const pool = buildPool(legs, 200);
  const res = [];
  const usedBets = {}; // allow each bet up to 2 uses per button group
  const n = pool.length;

  function add(par) {
  if (!par) return;

  // ❌ Skip if any leg has already been used 2+ times
  if (par.legs.some(l => (usedBets[l.desc] || 0) >= 2)) return;

  // ✅ Limit: no more than 1 "win" type per parlay
  const winCount = par.legs.filter(l => l.type === 'win').length;
  if (winCount > 2) return;

  // 🚫 NEW RULE: Skip parlays with total odds under 1.70
  if (par.parlayDec < 1.7) return;

  res.push(par);
  par.legs.forEach(l => {
    usedBets[l.desc] = (usedBets[l.desc] || 0) + 1;
  });

  res.sort((a, b) => b.parlaySimPct - a.parlaySimPct);
  if (res.length > limit) res.pop();
}

  // Generate parlays (avoid same match in one parlay)
  if (size === 2) {
    for (let i = 0; i < n; i++)
      for (let j = i + 1; j < n; j++) {
        const arr = [pool[i], pool[j]];
        if (new Set(arr.map(x => x.matchId)).size < size) continue;
        add(combine(arr));
      }
  } else if (size === 3) {
    for (let i = 0; i < n; i++)
      for (let j = i + 1; j < n; j++)
        for (let k = j + 1; k < n; k++) {
          const arr = [pool[i], pool[j], pool[k]];
          if (new Set(arr.map(x => x.matchId)).size < size) continue;
          add(combine(arr));
        }
  } else if (size === 4) {
    for (let i = 0; i < n; i++)
      for (let j = i + 1; j < n; j++)
        for (let k = j + 1; k < n; k++)
          for (let l = k + 1; l < n; l++) {
            const arr = [pool[i], pool[j], pool[k], pool[l]];
            if (new Set(arr.map(x => x.matchId)).size < size) continue;
            add(combine(arr));
          }
  }

  return res;
}

function legHTML(l){
  return `<div class="leg">
    <div class="left"><div class="title">${l.desc}</div><div class="tiny muted">${l.teams}${l.league?` • ${l.league}`:''}</div></div>
    <div class="right">
      <div class="row"><span class="muted">Sim%: </span><span><b>${l.simPct}%</b></span></div>
      <div class="row"><span class="muted">Bet365:</span><span><b>${l.bookOdds}</b></span></div>
      <div class="row"><span class="muted">Edge: </span><span class="pill">${l.edge>0?'+':''}${l.edge}%</span></div>
    </div>
  </div>`;
}

function parlayCardHTML(title,parlay){
  return `<div class="card">
    <h2>${title}</h2>
    <div class="kpi">
      <div><div class="tiny muted">Parlay Sim %</div><div class="big">${parlay.parlaySimPct}%</div></div>
      <div><div class="tiny muted">Betway Odds</div><div class="big">${parlay.parlayDec}</div></div>
      <div><div class="tiny muted">Edge</div><div class="big">${parlay.edge>0?'+':''}${parlay.edge}%</div></div>
    </div>
    <div class="legs">${parlay.legs.map(legHTML).join('')}</div>

    <!-- 🔹 Betway banner -->
    <div class="betway-banner">
      <a href="https://betway.com/bwp/sports-welcome-ie/en-ie/?s=sp50396&a=spadid219120" 
         target="_blank" rel="noopener noreferrer">
         <img src="logo.svg" alt="Betway Logo">
         <span>Bet on this parlay with</span>
      </a>
    </div>
  </div>`;
}

function showParlays(size){
  document.querySelectorAll(".btn").forEach(b => b.classList.remove("active"));
  const activeBtn = [...document.querySelectorAll(".btn")]
    .find(b => b.textContent.startsWith(size+"-Leg"));
  if (activeBtn) activeBtn.classList.add("active");

  const best = bestParlays(allLegs, size, 5);
  document.getElementById('parlay-cards').innerHTML =
    best.map((p,i)=>parlayCardHTML(`${size}-Leg Parlay #${i+1}`,p)).join('');
}

(async()=>{
  const fixtures=await fetch('fixtures.json').then(r=>r.json()).catch(()=>[]);
  allLegs=collectLegs(fixtures);
  showParlays(2);
})();
</script>


</body>
</html>