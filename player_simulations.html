<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Simulations | DataGaffer</title>
<style>
 body {
   font-family: Arial, sans-serif;
   background: #f2f4f7;
   margin: 0; padding: 0;
   color: #003f2e;
 }
 header {
   background: #003f2e;
   color: white;
   padding: 15px;
   text-align: center;
   font-size: 22px;
   font-weight: bold;
 }
 .banner {
   text-align: center;
   font-size: 20px;
   margin: 20px auto;
   color: #003f2e;
   background: #ffffff;
   padding: 10px;
   border: 2px solid #003f2e;
   width: 60%;
   border-radius: 4px;
   margin-bottom: 25px;
   margin-top: 40px;
   font-weight: 600;
   line-height: 1.5;
 }
 .buttons { text-align: center; margin-bottom: 20px; }
 .buttons button {
   margin: 0 10px;
   padding: 10px 20px;
   font-size: 16px;
   cursor: pointer;
   border: 2px solid #003f2e;
   border-radius: 4px;
   background: white;
   color: #003f2e;
 }
 .buttons button.active {
   background: #003f2e;
   color: white;
   font-weight: bold;
 }
 .search-box {
   text-align: center;
   margin-bottom: 20px;
 }
 .search-box input {
   width: 250px;
   padding: 8px;
   font-size: 14px;
   border: 2px solid #003f2e;
   border-radius: 6px;
 }
 table {
   width: 60%;
   max-width: 700px;
   margin: auto;
   border-collapse: collapse;
   background: white;
   font-size: 13px;
   border-radius: 10px;
   overflow: hidden;
   box-shadow: 0 4px 15px rgba(0,0,0,0.25);
   margin-bottom: 40px;
   table-layout: fixed;
 }
 th, td {
   padding: 4px 6px;
   text-align: center;
   border: 1px solid #ccc;
   font-weight: normal;
   word-wrap: break-word;
 }
 th {
   background: #003f2e;
   color: white;
   font-size: 14px;
   cursor: pointer;
 }
 td:first-child, th:first-child { width: 8%; }   /* Team */
 td:nth-child(2), th:nth-child(2) { width: 25%; font-weight: bold; } /* Player */
 td:nth-child(3), th:nth-child(3) { width: 12%; }  /* Pos */
 td:nth-child(n+4), th:nth-child(n+4) { width: 12%; } /* Stats */
 tr:nth-child(even) { background: #f2f2f2; }
 img { width: auto; height: 28px; vertical-align: middle; }
 .hidden { display: none; }

 .highlight-header { background: #fcff55 !important; color: black !important; }
 .highlight-col { background: #fff9b2 !important; color: black !important; }

/* ✅ Mobile version for Player Simulations */
@media (max-width: 768px) {
   .header-logo { height: 50px !important; width: auto !important; }
 h1 { font-size: 20px !important; }

 .banner {
   width: 85% !important;
   font-size: 13px !important;
   padding: 6px !important;
   margin-top: 25px;
 }

  .buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
    margin-bottom: 15px;
  }

  .buttons button {
    font-size: 14px;
    padding: 6px 10px;
    height: 34px;
    margin: 0;
  }

  .search-box input {
    width: 90%;
    font-size: 12px;
    padding: 6px;
  }

  table {
    width: 95%;
    font-size: 11px;
  }

  th, td {
    padding: 3px 4px;
    font-size: 11px;
  }

  img {
    height: 20px;
  }

  .section-title {
    font-size: 18px;
    margin: 15px 0 10px;
  }
}



</style>
</head>
<body>

<div style="background-color: #003f2e; color: white; padding: 10px 20px; position: relative; display: flex; align-items: center; justify-content: center;">
<a id="header-link" style="text-decoration: none; color: inherit; display: contents;">
 <img src="https://cdn.prod.website-files.com/682236b4aa8cdb4803142afd/68b8aa71d38f0c8d4c140700_everything-236.png"
    alt="DG Logo" class="header-logo"
    style="height: 90px; width: auto; position: absolute; left: 20px; top: 0px; z-index: 2;" />
<h1 style="margin: 0; font-size: 32px; font-weight: 700;">DataGaffer.com</h1>
</a>
</div>

<div class="banner">Today's top players after simulation results. /90 means average per90 stat after 5,000 match simulations. G= Goal A= Assist SOT= Shots on target SOA= Score or Assist</div>

<div class="buttons">
<button onclick="showSection('goals', this)" id="btn-goals" class="active">Goals</button>
<button onclick="showSection('assists', this)" id="btn-assists">Assists</button>
<button onclick="showSection('shots', this)" id="btn-shots">Shots/SOT</button>
<button onclick="showSection('soa', this)" id="btn-soa">Score or Assist</button>
</div>

<div class="search-box">
<input type="text" id="searchInput" placeholder="Search player, team, or position..." onkeyup="applySearch()" />
</div>

<div id="goals-section"></div>
<div id="assists-section" class="hidden"></div>
<div id="shots-section" class="hidden"></div>
<div id="soa-section" class="hidden"></div>

<script>
let allPlayers = [];
let sortConfig = { table: null, column: null, asc: false };
let teamLookup = {};

async function loadPlayerData() {
 const fixturesRes = await fetch("fixtures.json");
 const fixtures = await fixturesRes.json();
 const teamsRes = await fetch("teams.json");
 const teams = await teamsRes.json();
 teamLookup = Object.fromEntries(teams.map(t => [t.id, t.name]));

 const fixtureTeamIds = new Set();
 fixtures.forEach(f => {
   fixtureTeamIds.add(f.home.id);
   fixtureTeamIds.add(f.away.id);
 });

 const indexRes = await fetch("player_simulations/index.json");
 const files = await indexRes.json();

 let allTeamsPlayers = [];
 for (const file of files) {
   const res = await fetch("player_simulations/" + file);
   const teamPlayers = await res.json();
   teamPlayers.forEach(p => p.team = teamLookup[p.team_id] || "Unknown");
   allTeamsPlayers.push(...teamPlayers);
 }

 let players;
 if (fixtureTeamIds.size > 0) {
   players = allTeamsPlayers.filter(p => fixtureTeamIds.has(p.team_id));
 } else {
   players = allTeamsPlayers;
 }
 allPlayers = players;
 return players;
}

// ---------- Table builders ----------
function buildGoals(players) {
 let table = `<table><tr id="goals-header">
   <th onclick="sortTable('goals',0)">Team</th>
   <th onclick="sortTable('goals',1)">Player</th>
   <th onclick="sortTable('goals',2)">Pos</th>
   <th onclick="sortTable('goals',3)">Goals/90</th>
   <th onclick="sortTable('goals',4)">+1 Goal %</th>
 </tr>`;
 players.forEach(p => {
   const logoPath = `assets/logos/${p.team_id}.png`;
   table += `<tr>
     <td><img src="${logoPath}" alt="${p.team}" onerror="this.onerror=null;this.src='assets/logos/${p.team_id}.svg';"></td>
     <td>${p.name}</td><td>${p.position}</td>
     <td>${(p.goals_per90_simulated ?? 0).toFixed(2)}</td>
     <td>${(p["+1_goal_pct"] ?? 0).toFixed(1)}%</td>
   </tr>`;
 });
 return table + "</table>";
}

function buildAssists(players) {
 let table = `<table><tr id="assists-header">
   <th onclick="sortTable('assists',0)">Team</th>
   <th onclick="sortTable('assists',1)">Player</th>
   <th onclick="sortTable('assists',2)">Pos</th>
   <th onclick="sortTable('assists',3)">Assists/90</th>
   <th onclick="sortTable('assists',4)">+1 A%</th>
 </tr>`;
 players.forEach(p => {
   const logoPath = `assets/logos/${p.team_id}.png`;
   table += `<tr>
     <td><img src="${logoPath}" alt="${p.team}" onerror="this.onerror=null;this.src='assets/logos/${p.team_id}.svg';"></td>
     <td>${p.name}</td><td>${p.position}</td>
     <td>${(p.assists_per90_simulated ?? 0).toFixed(2)}</td>
     <td>${(p["+1_assist_pct"] ?? 0).toFixed(1)}%</td>
   </tr>`;
 });
 return table + "</table>";
}

function buildShots(players) {
 let table = `<table><tr id="shots-header">
   <th onclick="sortTable('shots',0)">Team</th>
   <th onclick="sortTable('shots',1)">Player</th>
   <th onclick="sortTable('shots',2)">Pos</th>
   <th onclick="sortTable('shots',3)">Shots/90</th>
   <th onclick="sortTable('shots',4)">SOT/90</th>
 </tr>`;
 players.forEach(p => {
   const logoPath = `assets/logos/${p.team_id}.png`;
   table += `<tr>
     <td><img src="${logoPath}" alt="${p.team}" onerror="this.onerror=null;this.src='assets/logos/${p.team_id}.svg';"></td>
     <td>${p.name}</td><td>${p.position}</td>
     <td>${(p.shots_per90 ?? 0).toFixed(2)}</td>
     <td>${(p.sot_per90 ?? 0).toFixed(2)}</td>
   </tr>`;
 });
 return table + "</table>";
}

function buildSOA(players) {
 let table = `<table><tr id="soa-header">
   <th onclick="sortTable('soa',0)">Team</th>
   <th onclick="sortTable('soa',1)">Player</th>
   <th onclick="sortTable('soa',2)">Pos</th>
   <th onclick="sortTable('soa',3)">SOA %</th>
 </tr>`;
 players.forEach(p => {
   const logoPath = `assets/logos/${p.team_id}.png`;
   table += `<tr>
     <td><img src="${logoPath}" alt="${p.team}" onerror="this.onerror=null;this.src='assets/logos/${p.team_id}.svg';"></td>
     <td>${p.name}</td><td>${p.position}</td>
     <td>${(p.soa_pct ?? 0).toFixed(1)}%</td>
   </tr>`;
 });
 return table + "</table>";
}

// ---------- Sorting + Highlight ----------
function sortTable(section, col) {
 if (sortConfig.table !== section || sortConfig.column !== col) {
   sortConfig.asc = false;
 } else {
   sortConfig.asc = !sortConfig.asc;
 }
 sortConfig.table = section;
 sortConfig.column = col;

 let sorted = [...allPlayers];
 sorted.sort((a, b) => {
   let valA, valB;
   switch(section) {
     case 'goals':
       if (col===0) {valA=a.team; valB=b.team;}
       if (col===1) {valA=a.name; valB=b.name;}
       if (col===2) {valA=a.position; valB=b.position;}
       if (col===3) {valA=a.goals_per90_simulated; valB=b.goals_per90_simulated;}
       if (col===4) {valA=a["+1_goal_pct"]; valB=b["+1_goal_pct"];}
       break;
     case 'assists':
       if (col===0) {valA=a.team; valB=b.team;}
       if (col===1) {valA=a.name; valB=b.name;}
       if (col===2) {valA=a.position; valB=b.position;}
       if (col===3) {valA=a.assists_per90_simulated; valB=b.assists_per90_simulated;}
       if (col===4) {valA=a["+1_assist_pct"]; valB=b["+1_assist_pct"];}
       break;
     case 'shots':
       if (col===0) {valA=a.team; valB=b.team;}
       if (col===1) {valA=a.name; valB=b.name;}
       if (col===2) {valA=a.position; valB=b.position;}
       if (col===3) {valA=a.shots_per90; valB=b.shots_per90;}
       if (col===4) {valA=a.sot_per90; valB=b.sot_per90;}
       break;
     case 'soa':
       if (col===0) {valA=a.team; valB=b.team;}
       if (col===1) {valA=a.name; valB=b.name;}
       if (col===2) {valA=a.position; valB=b.position;}
       if (col===3) {valA=a.soa_pct; valB=b.soa_pct;}
       break;
   }
   if (typeof valA==="string") valA = valA.toLowerCase();
   if (typeof valB==="string") valB = valB.toLowerCase();
   if (valA < valB) return sortConfig.asc ? -1 : 1;
   if (valA > valB) return sortConfig.asc ? 1 : -1;
   return 0;
 });

 if (section==='goals') document.getElementById("goals-section").innerHTML = buildGoals(sorted);
 if (section==='assists') document.getElementById("assists-section").innerHTML = buildAssists(sorted);
 if (section==='shots') document.getElementById("shots-section").innerHTML = buildShots(sorted);
 if (section==='soa') document.getElementById("soa-section").innerHTML = buildSOA(sorted);

 // reset highlights
 document.querySelectorAll("th, td").forEach(cell => {
   cell.classList.remove("highlight-header", "highlight-col");
 });

 // highlight clicked header + col
 const tableId = section+"-section";
 const headerRow = document.querySelector("#"+tableId+" table tr:first-child");
 if (headerRow) {
   const headerCells = headerRow.querySelectorAll("th");
   if (headerCells[col]) headerCells[col].classList.add("highlight-header");
 }
 const rows = document.querySelectorAll("#"+tableId+" table tr");
 rows.forEach((row, i) => {
   if (i === 0) return;
   const cells = row.querySelectorAll("td");
   if (cells[col]) cells[col].classList.add("highlight-col");
 });
}

// ---------- Search ----------
function applySearch() {
 const term = document.getElementById("searchInput").value.toLowerCase();
 const filtered = allPlayers.filter(p =>
   p.name.toLowerCase().includes(term) ||
   (p.team && p.team.toLowerCase().includes(term)) ||
   p.position.toLowerCase().includes(term)
 );
 if (!document.getElementById("goals-section").classList.contains("hidden")) document.getElementById("goals-section").innerHTML = buildGoals(filtered);
 if (!document.getElementById("assists-section").classList.contains("hidden")) document.getElementById("assists-section").innerHTML = buildAssists(filtered);
 if (!document.getElementById("shots-section").classList.contains("hidden")) document.getElementById("shots-section").innerHTML = buildShots(filtered);
 if (!document.getElementById("soa-section").classList.contains("hidden")) document.getElementById("soa-section").innerHTML = buildSOA(filtered);
}

async function init() {
  const players = await loadPlayerData();
  document.getElementById("goals-section").innerHTML = buildGoals(players);
  document.getElementById("assists-section").innerHTML = buildAssists(players);
  document.getElementById("shots-section").innerHTML = buildShots(players);
  document.getElementById("soa-section").innerHTML = buildSOA(players);
}
init();


// Auto-select section if ?section= is in the URL
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const section = urlParams.get("section") || "goals";

  // find the right button and trigger
  const btn = document.getElementById("btn-" + section);
  if (btn) {
    showSection(section, btn);
  }
});

init();

function showSection(section, btn) {
  // hide all
  document.querySelectorAll("#goals-section, #assists-section, #shots-section, #soa-section")
    .forEach(el => el.classList.add("hidden"));
  document.querySelectorAll(".buttons button").forEach(b => b.classList.remove("active"));

  // show selected
  document.getElementById(section + "-section").classList.remove("hidden");
  btn.classList.add("active");

  // rebuild the right table
  switch(section) {
    case "goals":
      document.getElementById("goals-section").innerHTML = buildGoals(allPlayers);
      break;
    case "assists":
      document.getElementById("assists-section").innerHTML = buildAssists(allPlayers);
      break;
    case "shots":
      document.getElementById("shots-section").innerHTML = buildShots(allPlayers);
      break;
    case "soa":
      document.getElementById("soa-section").innerHTML = buildSOA(allPlayers);
      break;
  }
}

</script>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* --- Supabase setup --- */
const SUPABASE_URL = "https://qgniftwopmhhcwiatkku.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnbmlmdHdvcG1oaGN3aWF0a2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjc2MzMsImV4cCI6MjA3MzgwMzYzM30.TYHTz4d9bT7OjdEkmu0m5lu-St75BWHOJQd8FLcKm5E";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* --- Inactivity logout (15 minutes) --- */
const INACTIVITY_LIMIT = 15 * 60 * 1000; 
let inactivityTimer;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(async () => {
    console.log("Auto-logout after inactivity");
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }, INACTIVITY_LIMIT);
}

// Reset timer on user activity
["click","mousemove","keydown","scroll","touchstart"].forEach(evt =>
  document.addEventListener(evt, resetInactivityTimer)
);

// Start timer when page loads
resetInactivityTimer();

/* --- Explicit logout handling --- */
supabaseClient.auth.onAuthStateChange((event) => {
  if (event === "SIGNED_OUT") {
    console.log("User signed out → redirecting to login");
    window.location.href = "login.html";
  }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const { data: { session }, error } = await supabaseClient.auth.getSession();
  if (error || !session) {
    console.warn("No session → redirecting to login");
    window.location.href = "login.html";
    return;
  }

  // Look up subscription + plan
  const { data: profile, error: profileError } = await supabaseClient
    .from("profiles")
    .select("is_subscribed, plan")
    .eq("id", session.user.id)
    .single();

  if (profileError || !profile?.is_subscribed) {
    console.warn("Not subscribed → redirecting to subscribe");
    window.location.href = "subscribe.html";
    return;
  }

  // ✅ Route header link depending on plan
  if (profile.plan === "20_new") {
  document.getElementById("header-link").href = "standard.html";
} else {
  document.getElementById("header-link").href = "dashboard.html";
}

  console.log("DEBUG profile:", profile);
});
</script>

</body>
</html>








