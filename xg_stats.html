<html>
<head>
 <title>Expected Stats</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <style>
   body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
   header { background: #003f2e; color: white; padding: 15px; text-align: center; font-size: 22px; font-weight: bold; }

   .banner {
     text-align: center;
     font-size: 20px;
     margin: 20px auto;
     color: #003f2e;
     background: #e6f4ec;
     padding: 10px;
     border-left: 6px solid #003f2e;
     width: 60%;
     border-radius: 4px;
     margin-bottom: 40px;
     margin-top: 40px;
   }

   .container {
     max-width: 1200px;
     margin: auto;
     padding: 30px 20px;
   }

   .buttons { text-align: center; margin-bottom: 20px; }
   .buttons button {
     margin: 0 10px;
     padding: 10px 20px;
     font-size: 16px;
     cursor: pointer;
     border: 2px solid #003f2e;
     border-radius: 4px;
     background: white;
     color: #003f2e;
   }
   .buttons button.active {
     background: #003f2e;
     color: white;
     font-weight: bold;
   }

   .search-box {
     text-align: center;
     margin-bottom: 20px;
   }
   .search-box input {
     width: 250px;
     padding: 8px;
     font-size: 14px;
     border: 2px solid #003f2e;
     border-radius: 6px;
   }

   table {
     width: 85%;
     max-width: 950px;
     margin: auto;
     border-collapse: collapse;
     background: white;
     font-size: 18px;
     line-height: 1.2;
     border-radius: 10px;
     overflow: hidden;
     box-shadow: 0 2px 5px rgba(0,0,0,0.1);
     margin-bottom: 40px;
   }

   th, td {
     padding: 8px 10px;
     text-align: center;
     border: 1px solid #ccc;
     font-weight: normal;
   }
   th {
     background: #003f2e;
     color: white;
     font-size: 18px;
     cursor: pointer;
   }

   th.sortable:hover { background: #003f2e; }

   th:first-child { border-top-left-radius: 10px; }
   th:last-child { border-top-right-radius: 10px; }

   img { width: 30px; height: 30px; vertical-align: middle; }
   tr:nth-child(even) { background: #f2f2f2; }

   .sorted-col { background: #fffacd !important; font-weight: bold; }
   .active-header { background: #fcff55 !important; color: black !important; border-bottom: 1px solid #ffffff; }

   /* ðŸ”¹ Fix Home Team & Away Team column widths */
   td:nth-child(2), th:nth-child(2),
   td:nth-child(6), th:nth-child(6) {
     width: 180px;
     white-space: nowrap;
     max-width: 180px;
     overflow: hidden;
     text-overflow: ellipsis;
   }

 /* --- Mobile adjustments --- */
@media (max-width: 925px) {
 body { overflow-x: hidden; }

 .header-logo { height: 50px !important; width: auto !important; }
 h1 { font-size: 20px !important; }

 .banner {
   width: 85% !important;
   font-size: 13px !important;
   padding: 6px !important;
   margin-top: 25px;
 }

 .buttons { margin-bottom: 30px; margin-top: 25px; }
 .buttons button {
   padding: 6px 10px !important;
   font-size: 12px !important;
   margin: 0 4px !important;
 }

 .container { max-width: 100%; padding: 0 5px; }

 table {
   width: 95% !important;
   max-width: 100% !important;
   font-size: 12px !important;
   margin: auto;
   margin-bottom: 25px;
   table-layout: fixed;
 }

 th, td {
   padding: 4px !important;
   font-size: 12px !important;
   word-wrap: break-word;
 }

 img { width: 20px !important; height: 20px !important; }

 td:nth-child(2), th:nth-child(2),
 td:nth-child(6), th:nth-child(6) {
   width: 22% !important;
 }
}
 </style>
</head>
<body>
 <div style="background-color: #003f2e; color: white; padding: 10px 20px; position: relative; display: flex; align-items: center; justify-content: center;">
   <a href="index.html" style="text-decoration: none; color: inherit; display: contents;">
  <img src="https://cdn.prod.website-files.com/682236b4aa8cdb4803142afd/68b8aa71d38f0c8d4c140700_everything-236.png"
        alt="DG Logo"
        class="header-logo"
        style="height: 90px; width: auto; position: absolute; left: 20px; top: 0px; z-index: 2;" />
   <h1 style="margin: 0; font-size: 32px; font-weight: 700;">DataGaffer.com</h1>
</a>
  </div>

 <div class="banner">Expected goals, corners and shot stats after 5,000 match simulations</div>

 <div class="buttons">
   <button id="btn-xg" onclick="showTable('xg', this)">Expected Goals</button>
   <button id="btn-corners" onclick="showTable('corners', this)">Expected Corners</button>
   <button id="btn-shots" onclick="showTable('shots', this)">Expected Shots</button>
 </div>

 <!-- ðŸ”¹ New Search Box -->
 <div class="search-box">
   <input type="text" id="searchInput" placeholder="Search team, matchup, or league..." onkeyup="applySearch()" />
 </div>

 <div id="tables"></div>

 <script>
   let allFixtures = [];
   let currentFixtures = [];
   let currentType = "xg";
   let sortConfig = { column: null, asc: false };

   async function loadFixtures() {
     const response = await fetch("fixtures.json");
     const fixtures = await response.json();
     allFixtures = fixtures;
     return fixtures;
   }

   function buildTable(fixtures, type) {
     let table = `
       <table id="statsTable">
         <tr>
           <th></th>
           <th>Home Team</th>
           <th class="sortable" onclick="sortTable(2, this)">Team</th>
           <th class="sortable" onclick="sortTable(3, this)">Total</th>
           <th class="sortable" onclick="sortTable(4, this)">Team</th>
           <th>Away Team</th>
           <th></th>
         </tr>
     `;

     fixtures.forEach(f => {
       const home = f.home.name;
       const away = f.away.name;
       const homeLogo = f.home.logo;
       const awayLogo = f.away.logo;

       const stats = f.sim_stats[type.toLowerCase()];
       if (!stats) return;

       table += `
         <tr>
           <td><img src="${homeLogo}" alt="${home}"></td>
           <td>${home}</td>
           <td>${stats.home}</td>
           <td>${stats.total}</td>
           <td>${stats.away}</td>
           <td>${away}</td>
           <td><img src="${awayLogo}" alt="${away}"></td>
         </tr>
       `;
     });

     table += `</table>`;
     return table;
   }

   function applySearch() {
     const searchTerm = document.getElementById("searchInput").value.toLowerCase();
     const filtered = allFixtures.filter(f =>
       f.home.name.toLowerCase().includes(searchTerm) ||
       f.away.name.toLowerCase().includes(searchTerm) ||
       (f.league && f.league.name.toLowerCase().includes(searchTerm))
     );
     document.getElementById("tables").innerHTML = buildTable(filtered, currentType);
   }

   async function showTable(type, btn = null) {
     currentFixtures = await loadFixtures();
     currentType = type;
     document.getElementById("tables").innerHTML = buildTable(currentFixtures, type);

     sortConfig = { column: null, asc: false };

     document.querySelectorAll(".buttons button").forEach(b => b.classList.remove("active"));
     if (btn) btn.classList.add("active");
   }

   function sortTable(colIndex, header) {
     const table = document.getElementById("statsTable");
     let rows = Array.from(table.rows).slice(1);

     const asc = sortConfig.column === colIndex ? !sortConfig.asc : false;
     sortConfig = { column: colIndex, asc };

     rows.sort((a, b) => {
       let valA = parseFloat(a.cells[colIndex].innerText) || 0;
       let valB = parseFloat(b.cells[colIndex].innerText) || 0;
       return asc ? valA - valB : valB - valA;
     });

     rows.forEach(row => table.appendChild(row));

     rows.forEach(row => {
       for (let i = 2; i <= 4; i++) row.cells[i].classList.remove("sorted-col");
     });
     document.querySelectorAll("th.sortable").forEach(th => th.classList.remove("active-header"));

     rows.forEach(row => row.cells[colIndex].classList.add("sorted-col"));
     header.classList.add("active-header");
   }

   showTable("xg", document.getElementById("btn-xg"));
 </script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
<script>
  // ---- CONFIG ----
  const SUPABASE_URL = "https://qgniftwopmhhcwiatkku.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnbmlmdHdvcG1oaGN3aWF0a2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjc2MzMsImV4cCI6MjA3MzgwMzYzM30.TYHTz4d9bT7OjdEkmu0m5lu-St75BWHOJQd8FLcKm5E";
  const PROJECT_REF = "qgniftwopmhhcwiatkku"; // from your Supabase URL

  // Create client with persistent session
  const supabaseClient = (() => {
    // supabase is available because script is "defer"
    return supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, storage: window.localStorage }
    });
  })();

  // Fast token check (no race): if token key exists, treat as signed-in initially
  function hasStoredToken() {
    const key = `sb-${PROJECT_REF}-auth-token`;
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return false;
      const obj = JSON.parse(raw);
      return !!(obj?.currentSession?.access_token);
    } catch (_) {
      return false;
    }
  }

  async function ensureSignedIn() {
    // 1) Fast path: if token exists, let the page render and validate in background
    const optimistic = hasStoredToken();

    // 2) Validate the session (with a retry) without instantly bouncing the user
    let { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      // small retry to cover Safari restore lag
      await new Promise(r => setTimeout(r, 700));
      ({ data: { session } } = await supabaseClient.auth.getSession());
    }

    if (session) {
      // Valid session -> keep user here
      window.currentUser = session.user;
      return;
    }

    // No session after validation:
    if (!optimistic) {
      // we never had a stored token either, so it's truly signed out
      window.location.href = "login.html";
    } else {
      // Edge case: token existed but session couldnâ€™t be restored â†’ treat as signed out
      window.location.href = "login.html";
    }
  }

  // Only redirect on explicit sign-out; do nothing on page load
  supabaseClient.auth.onAuthStateChange((event) => {
    if (event === "SIGNED_OUT") window.location.href = "login.html";
  });

  // Make sure logo always goes to index.html (no other logic)
  function wireLogo() {
    const logoA = document.querySelector('.dg-logo-wrapper a') || document.querySelector('a[href="index.html"]');
    if (!logoA) return;
    logoA.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = "index.html";
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    wireLogo();
    ensureSignedIn();
  });
</script>

<script>
const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 minutes in ms
let inactivityTimer;

// Reset inactivity timer
function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        console.log("Auto-logout after inactivity");
        await supabase.auth.signOut();
        window.location.href = "login.html"; // redirect after auto-logout
      } else {
        console.log("No active session, skip auto-logout");
      }
    } catch (err) {
      console.error("Error during inactivity check:", err);
    }
  }, INACTIVITY_LIMIT);
}

// Reset timer on user activity
["click", "mousemove", "keydown", "scroll", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetInactivityTimer);
});

// Start timer on page load
resetInactivityTimer();
</script>



</body>
</html>






